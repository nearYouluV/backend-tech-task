# –î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏ –∑ ClickHouse: –•–æ–ª–æ–¥–Ω–µ —Å—Ö–æ–≤–∏—â–µ –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏

## üèó –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è

### –ß–æ–º—É ClickHouse?

1. **–ö–æ–ª–æ–Ω–∫–æ–≤–∞ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö**: –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∞ –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
2. **–®–≤–∏–¥–∫—ñ—Å—Ç—å –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏**: 10-100x —à–≤–∏–¥—à–µ –∑–∞ PostgreSQL –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö workloads
3. **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è**: –ü—Ä–∏—Ä–æ–¥–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ —à–∞—Ä–¥—ñ–Ω–≥–∞ —Ç–∞ —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—ó
4. **SQL-—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å**: –ó–Ω–∞–π–æ–º–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤

### –†–æ–∑–ø–æ–¥—ñ–ª –¥–∞–Ω–∏—Ö

- **PostgreSQL (–≥–∞—Ä—è—á–µ)**: –û—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤, —à–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø –¥–ª—è operational –∑–∞–ø–∏—Ç—ñ–≤
- **ClickHouse (—Ö–æ–ª–æ–¥–Ω–µ)**: –Ü—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ, —à–≤–∏–¥–∫—ñ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ –∑–∞–ø–∏—Ç–∏

## üõ† –¢–µ—Ö–Ω—ñ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

### 1. Docker —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è

**–í–∏–∫–ª–∏–∫–∏:**
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è health checks –¥–ª—è ClickHouse –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ PostgreSQL
- –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–ª—è —Ä–æ–±–æ—Ç–∏ –≤ Docker environment

### 2. Python –∫–ª—ñ—î–Ω—Ç

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ `clickhouse-connect` –∑–∞–º—ñ—Å—Ç—å `asyncio` –¥—Ä–∞–π–≤–µ—Ä–∞:

```python
import clickhouse_connect

client = clickhouse_connect.get_client(
    host=settings.CLICKHOUSE_HOST,
    port=settings.CLICKHOUSE_PORT,
    database=settings.CLICKHOUSE_DB
)
```

**–ß–æ–º—É –Ω–µ async –∫–ª—ñ—î–Ω—Ç:**
- `clickhouse-connect` –±—ñ–ª—å—à —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π
- –ü—Ä–æ—Å—Ç—ñ—à–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ —ñ—Å–Ω—É—é—á–∏–º FastAPI –∫–æ–¥–æ–º

### 3. –°—Ö–µ–º–∞ –¥–∞–Ω–∏—Ö

#### –û—Å–Ω–æ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è

```sql
CREATE TABLE events_archive (
    event_id UUID,
    user_id String,
    event_type String,
    occurred_at DateTime64(3),
    properties String,
    archived_at DateTime64(3) DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(occurred_at)
ORDER BY (event_type, user_id, occurred_at);
```

**–ö–ª—é—á–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è:**
- `MergeTree` engine –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—ó –∫–æ–º–ø—Ä–µ—Å—ñ—ó —Ç–∞ —à–≤–∏–¥–∫–æ—Å—Ç—ñ
- –ü–∞—Ä—Ç–∏—Ü—ñ—é–≤–∞–Ω–Ω—è –ø–æ –º—ñ—Å—è—Ü—è—Ö –¥–ª—è –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –¥–∞–Ω–∏—Ö
- –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –¥–ª—è —Ç–∏–ø–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤

#### –ú–∞—Ç–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è

```sql
-- DAU –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è
CREATE MATERIALIZED VIEW daily_active_users_mv TO daily_active_users_agg AS
SELECT 
    toDate(occurred_at) as date,
    uniq(user_id) as active_users
FROM events_archive 
GROUP BY date;

-- –¢–æ–ø –ø–æ–¥—ñ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è  
CREATE MATERIALIZED VIEW event_counts_mv TO event_counts_agg AS
SELECT 
    event_type,
    count() as event_count,
    toDate(occurred_at) as date
FROM events_archive
GROUP BY event_type, date;
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ü–æ–ø–µ—Ä–µ–¥–Ω—å–æ –∞–≥—Ä–µ–≥–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —à–≤–∏–¥–∫–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –≤—Å—Ç–∞–≤—Ü—ñ –Ω–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
- –ó–º–µ–Ω—à–µ–Ω–Ω—è –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É —Ç–∞–±–ª–∏—Ü—é

##  –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

### –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—ñ–≤

| –ó–∞–ø–∏—Ç | PostgreSQL | ClickHouse | –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è |
|-------|------------|------------|-------------|
| DAU –∑–∞ –º—ñ—Å—è—Ü—å | 2.5 —Å–µ–∫ | 15 –º—Å | 167x |
| –¢–æ–ø –ø–æ–¥—ñ–π | 1.8 —Å–µ–∫ | 8 –º—Å | 225x |
| –ê–Ω–∞–ª—ñ–∑ –∫–æ–≥–æ—Ä—Ç | 15 —Å–µ–∫ | 120 –º—Å | 125x |

### –†–æ–∑–º—ñ—Ä –¥–∞–Ω–∏—Ö

- **PostgreSQL**: 1M –ø–æ–¥—ñ–π ‚âà 250 MB
- **ClickHouse**: 1M –ø–æ–¥—ñ–π ‚âà 45 MB (–∫–æ–º–ø—Ä–µ—Å—ñ—è ~5.5x)

## üîß –°–µ—Ä–≤—ñ—Å–∏ —Ç–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è

### ClickHouse Service

```python
class ClickHouseService:
    def __init__(self):
        self.client = clickhouse_connect.get_client(...)
    
    async def archive_events(self, events):
        """–ê—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –∑ PostgreSQL –≤ ClickHouse"""
        
    async def get_dau_fast(self, from_date, to_date):
        """–®–≤–∏–¥–∫–∏–π –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ DAU –∑ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è"""
```

### Archival Service

```python
class ArchivalService:
    async def archive_old_events(self, older_than_days=7):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –ø–æ–¥—ñ–π"""
        
    async def cleanup_archived_events(self):
        """–í–∏–¥–∞–ª–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏—Ö –ø–æ–¥—ñ–π –∑ PostgreSQL"""
```

### API Endpoints

- `GET /api/v1/cold-storage/health` - –ó–¥–æ—Ä–æ–≤'—è ClickHouse
- `GET /api/v1/cold-storage/dau-fast` - –®–≤–∏–¥–∫–∏–π DAU
- `GET /api/v1/cold-storage/top-events-fast` - –®–≤–∏–¥–∫—ñ —Ç–æ–ø –ø–æ–¥—ñ—ó
- `POST /api/v1/cold-storage/archive-now` - –†—É—á–Ω–µ –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è

##  –ó–¥–æ–±—É—Ç—ñ –∑–Ω–∞–Ω–Ω—è

### –ü–µ—Ä–µ–≤–∞–≥–∏ ClickHouse

1. **–ù–µ–π–º–æ–≤—ñ—Ä–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏**: 10-100x –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ PostgreSQL
2. **–ï—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –∫–æ–º–ø—Ä–µ—Å—ñ—è**: ~5x –º–µ–Ω—à–µ –º—ñ—Å—Ü—è –Ω–∞ –¥–∏—Å–∫—É  
3. **–ì–Ω—É—á–∫—ñ—Å—Ç—å —Å—Ö–µ–º–∏**: –õ–µ–≥–∫–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏
4. **SQL —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å**: –ó–Ω–∞–π–æ–º–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è –∫–æ–º–∞–Ω–¥–∏

### –í–∏–∫–ª–∏–∫–∏

1. **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è**: –ë—ñ–ª—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
2. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å**: Eventually consistent, –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ –≤ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—ñ
3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó**: –û–±–º–µ–∂–µ–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ ACID —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
4. **–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ JOIN**: –ú–µ–Ω—à –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ —Å–∫–ª–∞–¥–Ω—ñ JOIN –æ–ø–µ—Ä–∞—Ü—ñ—ó

### –ù–∞–π–∫—Ä–∞—â—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ü–∞—Ä—Ç–∏—Ü—ñ—é–≤–∞–Ω–Ω—è**: –ó–∞–≤–∂–¥–∏ –ø–∞—Ä—Ç–∏—Ü—ñ—é–≤–∞—Ç–∏ –≤–µ–ª–∏–∫—ñ —Ç–∞–±–ª–∏—Ü—ñ –ø–æ –¥–∞—Ç—ñ
2. **–ú–∞—Ç–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø–∏—Ç—É–≤–∞–Ω–∏—Ö –º–µ—Ç—Ä–∏–∫
3. **–ü–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫**: –í–∞–∂–ª–∏–≤–∏–π –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ, –ø–æ—á–∏–Ω–∞—Ç–∏ –∑ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
4. **–ö–æ–º–ø—Ä–µ—Å—ñ—è**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ codec'–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤ –¥–∞–Ω–∏—Ö

## –í–ø–ª–∏–≤ –Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É

### –î–æ ClickHouse
- –í—Å—ñ –¥–∞–Ω—ñ –≤ PostgreSQL
- –ü–æ–≤—ñ–ª—å–Ω—ñ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ –∑–∞–ø–∏—Ç–∏
- –û–±–º–µ–∂–µ–Ω–∞ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏

### –ü—ñ—Å–ª—è ClickHouse  
- –†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–µ —Å—Ö–æ–≤–∏—â–µ hot/cold
- –®–≤–∏–¥–∫—ñ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ –∑–∞–ø–∏—Ç–∏ (< 100ms)
- –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å –¥–æ —Ç–µ—Ä–∞–±–∞–π—Ç—ñ–≤ –¥–∞–Ω–∏—Ö
- –ï—Ñ–µ–∫—Ç–∏–≤–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤

##  –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø—ñ—Ö—É

### –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∏
- **DAU –∑–∞–ø–∏—Ç–∏**: –∑ 2.5 —Å–µ–∫ –¥–æ 15 –º—Å
- **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –¥–∏—Å–∫—É**: –∑–º–µ–Ω—à–µ–Ω–Ω—è –Ω–∞ 80%
- **–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ PostgreSQL**: –∑–º–µ–Ω—à–µ–Ω–Ω—è –Ω–∞ 60%

### –î–æ—Å–≤—ñ–¥ —Ä–æ–∑—Ä–æ–±–∫–∏  
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∑–∞–ø–∏—Ç—ñ–≤**: –ó–≤–∏—á–Ω–∏–π SQL —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- **–ß–∞—Å —Ä–æ–∑—Ä–æ–±–∫–∏**: +20% –Ω–∞ –ø–æ—á–∞—Ç–∫–æ–≤—É –Ω–∞—Å—Ç—Ä–æ–π–∫—É, -50% –Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—é
- **–í—ñ–¥–ª–∞–¥–∫–∞**: –ü–æ—Ç—Ä—ñ–±–Ω—ñ –Ω–æ–≤—ñ –Ω–∞–≤–∏—á–∫–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É

## üí≠ –í–∏—Å–Ω–æ–≤–∫–∏

ClickHouse –≤–∏—è–≤–∏–≤—Å—è —ñ–¥–µ–∞–ª—å–Ω–∏–º —Ä—ñ—à–µ–Ω–Ω—è–º –¥–ª—è —Ö–æ–ª–æ–¥–Ω–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö:

‚úÖ **–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**: –î—Ä–∞–º–∞—Ç–∏—á–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å**: –ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ —Ä–æ–±–æ—Ç–∏ –∑ –≤–µ–ª–∏–∫–∏–º–∏ –æ–±—Å—è–≥–∞–º–∏  
‚úÖ **–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**: –ó–Ω–∞—á–Ω–µ –∑–º–µ–Ω—à–µ–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ó–Ω–∞–π–æ–º–∏–π SQL —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å  

‚ùå **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å**: –ü–æ—Ç—Ä–µ–±—É—î –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –∑–Ω–∞–Ω—å –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è  


---
