# Architecture Decision Records (ADR)

---

## ADR-001: Вибір веб-фреймворку

### Статус
✅ **Прийнято**

### Контекст
Потрібно було обрати веб-фреймворк для створення високопродуктивного REST API з підтримкою асинхронної обробки великих обсягів даних (до 1000 подій за запит).

### Рішення
**Обрано: FastAPI**

### Обґрунтування

**Переваги FastAPI:**
- **Асинхронність**: Нативна підтримка async/await для високої пропускної здатності
- **Продуктивність**: Один з найшвидших Python фреймворків (базується на Starlette)
- **Автодокументація**: Автоматична генерація OpenAPI/Swagger документації
- **Валідація даних**: Інтеграція з Pydantic для строгої валідації
- **Типізація**: Повна підтримка Python type hints
- **Екосистема**: Велика кількість готових рішень та інтеграцій

**Розглянуті альтернативи:**

1. **Flask**
   - ❌ Відсутність нативної асинхронності
   - ❌ Потребує додаткових бібліотек для валідації
   - ✅ Простота та зрозумілість
   - ✅ Велика екосистема

2. **Django REST Framework**
   - ❌ Надлишковість для API-only застосунку
   - ❌ Повільніший у порівнянні з FastAPI
   - ✅ Готові рішення для аутентифікації
   - ✅ Адмін-панель


### Результати
- Досягнуто пропускної здатності 1,840 подій/сек
- Автоматична документація API доступна через Swagger UI
- Швидка розробка завдяки type hints та валідації

---

## ADR-002: Вибір архітектури сховища даних

### Статус
✅ **Прийнято**

### Контекст
Необхідно було розробити систему зберігання подій, яка підтримує:
- Високу швидкість запису подій
- Швидкі аналітичні запити
- Зберігання великих обсягів історичних даних
- Ефективне використання ресурсів

### Рішення
**Обрано: Гібридна архітектура гарячого/холодного сховища**
- **Гаряче сховище**: PostgreSQL (останні 7 днів)
- **Холодне сховище**: ClickHouse (архівні дані)

### Обґрунтування

**Переваги обраної архітектури:**

**PostgreSQL як гаряче сховище:**
- ✅ ACID транзакції для критично важливих даних
- ✅ Зрілість та надійність
- ✅ Відмінна підтримка JSON для властивостей подій
- ✅ Ефективні індекси для швидкого пошуку
- ✅ Складні запити з JOIN для реляційних даних

**ClickHouse як холодне сховище:**
- ✅ Стовпчасте зберігання для аналітики
- ✅ Високий рівень стиснення даних
- ✅ Швидкі агрегаційні запити
- ✅ Матеріалізовані представлення для попередньо обчислених метрик
- ✅ Горизонтальне масштабування

**Розглянуті альтернативи:**

1. **Тільки PostgreSQL**
   - ✅ Простота архітектури
   - ❌ Повільні аналітичні запити на великих обсягах
   - ❌ Високе споживання диска для історичних даних

2. **Тільки ClickHouse**
   - ✅ Відмінна аналітична продуктивність
   - ❌ Відсутність ACID транзакцій
   - ❌ Складність для простих CRUD операцій

3. **MongoDB + Elasticsearch**
   - ✅ Гнучкість схеми
   - ❌ Вища складність операційного супроводу
   - ❌ Більше споживання ресурсів


### Результати
- Швидкі записи: 1,840 подій/сек
- Аналітичні запити: 6-7 мс для складних агрегацій
- Ефективне використання диска завдяки стисненню ClickHouse
- Автоматичне архівування даних

---

## ADR-003: Оптимізація продуктивності

### Контекст
Система повинна обробляти високе навантаження (до 1000 подій за запит) та забезпечувати швидкі аналітичні запити.

### Рішення
**Обрано: Комплексний підхід до оптимізації**
- **Батчінг**: Групування подій для ефективного запису
- **Асинхронність**: async/await для всіх I/O операцій  
- **Connection pooling**: Пул з'єднань до баз даних
- **Матеріалізовані представлення**: Попередньо обчислені метрики
- **Ідемпотентність**: Уникнення дублювання подій

### Обґрунтування

**Ключові оптимізації:**

1. **Батчінг подій:**
   - Групування до 1000 подій в одну транзакцію
   - Зменшення кількості звернень до БД
   - Збільшення пропускної здатності у 5-10 разів

2. **Асинхронна обробка:**
   - Використання asyncio для конкурентної обробки
   - Неблокуючі операції з базами даних
   - Ефективне використання ресурсів сервера

3. **Connection pooling:**
   - 20 з'єднань у пулі для PostgreSQL
   - Переваги використання з'єднань
   - Зменшення латентності

4. **Матеріалізовані представлення ClickHouse:**
   - `daily_active_users_mv` - DAU метрики
   - `event_counts_mv` - Підрахунок подій
   - Реал-тайм оновлення при надходженні нових даних

**Результати оптимізації:**
- **Пропускна здатність**: 1,840 подій/сек (пік)
- **Середня пропускна здатність**: 1,691 подій/сек
- **Латентність аналітики**: 6-7 мс для складних запитів
- **Надійність**: 100% успішних запитів у тестах

### Альтернативи
- **Синхронна обробка**: На 60-80% повільніше
- **Поодинокі записи**: На 10x повільніше за батчінг
- **Обчислення метрик на льоту**: На 50-100x повільніше

---



### Обрані технології


- **Web Framework**  FastAPI  Продуктивність + асинхронність 
- **Гаряче сховище**  PostgreSQL Надійність + швидкість + доступність 
- **Холодне сховище**  ClickHouse Аналітична продуктивність 
- **Аутентифікація**  JWT Stateless + безпека 
- **Оркестрація**  Docker Compose Простота розгортання 
- **Тестування** pytest Гнучкість + async підтримка 
- **Валідація**  Pydantic Type safety + продуктивність 

### Ключові метрики досягнуті

- **Пропускна здатність**: 1,840 подій/сек
- **Латентність API**: 1-3 мс для простих запитів
- **Латентність аналітики**: 6-7 мс для складних агрегацій
- **Надійність**: 100% успішність у навантажувальних тестах
- **Час розгортання**: < 2 хвилин (з нуля до готової системи)

### Принципи архітектури

1. **Простота**: Мінімум компонентів, максимум функціональності
2. **Продуктивність**: Оптимізація критичних шляхів
3. **Надійність**: ACID транзакції, валідація, health checks
4. **Масштабованість**: Готовність до горизонтального масштабування
5. **Безпека**: Аутентифікація, авторизація, валідація входів
6. **Операційність**: Автоматизоване розгортання, моніторинг

